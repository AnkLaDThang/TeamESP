--// ================================
--//  DINHTHANG HUB | FULL OUTLINE FIX
--// ================================

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera
local lp = Players.LocalPlayer

-- SETTINGS
local ESP_SIZE = 12
local HEALTHBAR_WIDTH = 2
local HEALTHBAR_HEIGHT = 20
local AIM_FOV = 170
local AIM_SMOOTH = 0.25
local AIM_PART = "Head"

ESP_ENABLED = false
AIM_ENABLED = false

-- ================= GUI =================
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.Name = "DinhThangHub"

local floatBtn = Instance.new("TextButton", gui)
floatBtn.Size = UDim2.new(0,45,0,45)
floatBtn.Position = UDim2.new(0.03,0,0.5,0)
floatBtn.Text = "DT"
floatBtn.BackgroundColor3 = Color3.fromRGB(20,20,20)
floatBtn.TextColor3 = Color3.fromRGB(255,255,255)
floatBtn.Font = Enum.Font.GothamBold
floatBtn.TextSize = 18
floatBtn.BorderSizePixel = 0
floatBtn.Active = true
floatBtn.Draggable = true
Instance.new("UICorner", floatBtn).CornerRadius = UDim.new(1,0)

local main = Instance.new("Frame", gui)
main.Size = UDim2.new(0,230,0,160)
main.Position = UDim2.new(0.6,0,0.25,0)
main.BackgroundColor3 = Color3.fromRGB(22,22,22)
main.BorderSizePixel = 0
main.Active = true
main.Draggable = true
main.Visible = true
Instance.new("UICorner", main).CornerRadius = UDim.new(0,18)

local title = Instance.new("TextLabel", main)
title.Size = UDim2.new(1,0,0,35)
title.BackgroundTransparency = 1
title.Text = "DinhThang - HUB üòàüî•"
title.TextColor3 = Color3.fromRGB(255,255,255)
title.Font = Enum.Font.GothamBold
title.TextSize = 16

local function createBtn(text,y)
    local btn = Instance.new("TextButton", main)
    btn.Size = UDim2.new(0.88,0,0,40)
    btn.Position = UDim2.new(0.06,0,y,0)
    btn.Text = text
    btn.BackgroundColor3 = Color3.fromRGB(55,55,55)
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 16
    btn.BorderSizePixel = 0
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,14)
    return btn
end

local espBtn = createBtn("ESP : OFF",0.28)
local aimBtn = createBtn("AIMBOT : OFF",0.58)

espBtn.MouseButton1Click:Connect(function()
    ESP_ENABLED = not ESP_ENABLED
    espBtn.Text = ESP_ENABLED and "ESP : ON" or "ESP : OFF"
    espBtn.BackgroundColor3 = ESP_ENABLED and Color3.fromRGB(0,170,100) or Color3.fromRGB(55,55,55)
end)

aimBtn.MouseButton1Click:Connect(function()
    AIM_ENABLED = not AIM_ENABLED
    aimBtn.Text = AIM_ENABLED and "AIMBOT : ON" or "AIMBOT : OFF"
    aimBtn.BackgroundColor3 = AIM_ENABLED and Color3.fromRGB(170,0,0) or Color3.fromRGB(55,55,55)
end)

floatBtn.MouseButton1Click:Connect(function()
    main.Visible = not main.Visible
end)

-- ================= UTILS =================
local function isAlive(char)
    local hum = char:FindFirstChild("Humanoid")
    return hum and hum.Health > 0
end

local function isEnemy(plr)
    if not lp.Team or not plr.Team then return true end
    return plr.Team ~= lp.Team
end

local function getTeamColor(plr)
    if plr.Team and plr.Team.TeamColor then
        return plr.Team.TeamColor.Color
    end
    return Color3.fromRGB(255,255,255)
end

-- ================= HIGHLIGHT SYSTEM =================
local function applyHighlight(plr)
    if not plr.Character then return end

    local char = plr.Character
    if char:FindFirstChild("DT_Highlight") then return end

    local hl = Instance.new("Highlight")
    hl.Name = "DT_Highlight"
    hl.FillTransparency = 1
    hl.OutlineTransparency = 0.15  -- ƒë·∫≠m vi·ªÅn
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.Parent = char
end

local function removeHighlight(plr)
    if plr.Character and plr.Character:FindFirstChild("DT_Highlight") then
        plr.Character.DT_Highlight:Destroy()
    end
end

-- ================= ESP =================
local espCache = {}

local function createESP(plr)
    if plr == lp then return end

    local name = Drawing.new("Text")
    name.Size = ESP_SIZE
    name.Center = true
    name.Outline = true

    local health = Drawing.new("Square")
    health.Filled = true

    espCache[plr] = {name=name, health=health}

    if plr.Character then
        applyHighlight(plr)
    end
end

local function removeESP(plr)
    if espCache[plr] then
        for _,v in pairs(espCache[plr]) do
            v:Remove()
        end
        espCache[plr] = nil
    end
    removeHighlight(plr)
end

-- INIT PLAYERS
for _,p in pairs(Players:GetPlayers()) do
    if p ~= lp then
        createESP(p)
    end
    if p.Character then
        applyHighlight(p)
    end

    p.CharacterAdded:Connect(function()
        task.wait(0.3)
        applyHighlight(p)
    end)
end

Players.PlayerAdded:Connect(function(plr)
    createESP(plr)
    plr.CharacterAdded:Connect(function()
        task.wait(0.3)
        applyHighlight(plr)
    end)
end)

Players.PlayerRemoving:Connect(removeESP)

-- ================= AIMBOT =================
local function wallCheck(targetPos, targetChar)
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {lp.Character, targetChar}
    rayParams.FilterType = Enum.RaycastFilterType.Blacklist
    local ray = Workspace:Raycast(Camera.CFrame.Position, (targetPos - Camera.CFrame.Position), rayParams)
    return ray == nil
end

local function getClosestTarget()
    local closest = nil
    local minDist = AIM_FOV
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)

    for _,plr in pairs(Players:GetPlayers()) do
        if plr ~= lp and isEnemy(plr) and plr.Character and plr.Character:FindFirstChild(AIM_PART) and isAlive(plr.Character) then
            local part = plr.Character[AIM_PART]
            local pos, onscreen = Camera:WorldToViewportPoint(part.Position)
            if onscreen then
                local dist = (Vector2.new(pos.X,pos.Y) - center).Magnitude
                if dist < minDist then
                    if wallCheck(part.Position, plr.Character) then
                        minDist = dist
                        closest = plr
                    end
                end
            end
        end
    end
    return closest
end

-- ================= LOOP =================
RunService.RenderStepped:Connect(function()
    for plr,data in pairs(espCache) do
        local char = plr.Character
        if ESP_ENABLED and char and char:FindFirstChild("HumanoidRootPart") and isAlive(char) then
            local hrp = char.HumanoidRootPart
            local hum = char:FindFirstChild("Humanoid")
            local pos, onscreen = Camera:WorldToViewportPoint(hrp.Position)

            if onscreen then
                local color = getTeamColor(plr)

                -- NAME
                data.name.Visible = true
                data.name.Text = plr.Name
                data.name.Color = color
                data.name.Position = Vector2.new(pos.X,pos.Y-32)

                -- HEALTH
                if hum then
                    local hpPercent = hum.Health / hum.MaxHealth
                    data.health.Visible = true
                    data.health.Color = Color3.fromRGB(0,255,0)
                    data.health.Size = Vector2.new(HEALTHBAR_WIDTH, HEALTHBAR_HEIGHT * hpPercent)
                    data.health.Position = Vector2.new(pos.X-15,pos.Y-10 + (HEALTHBAR_HEIGHT - HEALTHBAR_HEIGHT*hpPercent))
                end

                -- HIGHLIGHT
                if char:FindFirstChild("DT_Highlight") then
                    char.DT_Highlight.OutlineColor = color
                    char.DT_Highlight.Enabled = true
                end
            else
                data.name.Visible = false
                data.health.Visible = false
                if char and char:FindFirstChild("DT_Highlight") then
                    char.DT_Highlight.Enabled = false
                end
            end
        else
            data.name.Visible = false
            data.health.Visible = false
            if char and char:FindFirstChild("DT_Highlight") then
                char.DT_Highlight.Enabled = false
            end
        end
    end

    -- AIMBOT (ENEMY ONLY)
    if AIM_ENABLED then
        local target = getClosestTarget()
        if target and target.Character and target.Character:FindFirstChild(AIM_PART) then
            local part = target.Character[AIM_PART]
            local camCF = Camera.CFrame
            local newCF = CFrame.new(camCF.Position, part.Position)
            Camera.CFrame = camCF:Lerp(newCF, AIM_SMOOTH)
        end
    end
end) 
